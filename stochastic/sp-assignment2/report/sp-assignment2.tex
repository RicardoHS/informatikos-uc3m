\documentclass[11pt, a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

\usepackage{amsmath,amssymb,amsthm,amsfonts,graphicx,float,fullpage,booktabs,bm} 
\usepackage[colorlinks,citecolor=blue,bookmarks=true]{hyperref}
\hypersetup{linkcolor=blue}
\usepackage{cleveref}
% Code listings
\usepackage{minted}
\usepackage{caption}
\usemintedstyle[python]{manni}
\usemintedstyle[R]{manni}
\usepackage{todonotes}
\usepackage[backend = bibtex]{biblatex}
\addbibresource{bibliography.bib}


\title{\vspace{-8ex} \huge \bfseries Stochastic Processes\\
	\LARGE \normalfont \textsc{Assignment Two} \vspace{-2ex}}
\author{\bfseries Santiago Alfonso Raposo Briceño - 100414456 \\
	\bfseries Javier Martínez Llamas - 100392684\\
	\bfseries Ricardo Hortelano Sánchez - 100418220}
\date{\vspace{-5ex}} % Remove space where date would be.

\begin{document}
	\maketitle
	\hrule

\section{Exercise 1}

\section{Exercise 2}
\subsection*{Question a}
The process $\bm{X} = \{X_t, \ t\geq 0\}$ is a continuous time Markov chain, as we are told that:
\begin{itemize}
	\item The customers arrive according ot a Poisson distribution with rate $\lambda$.
	\item Service times have an exponential distribution with rate $\mu$.
	\item There is no limit to the number of people in the system at any given time.
\end{itemize}

The \emph{state space} of our process is then $\{0\} \cup \mathbb{N}$. 
To obtain the infinitesimal generator, we observe that if $X_t = i$, then the only two possible transitions are into state $i+1$ if another customer joins the line and to state $i-1$ if a cashier finishes servicing its customer.

We know that the time until a new arrival takes place is just the interarrival time of a Poisson process, so it is exponentially distributed with rate $\lambda$.

The time until a customer is serviced is the minimum between the time it takes cashier $1$ to service its customer and the time it takes cashier $2$ to service theirs. 
This is the minimum of two exponentially distributed random variables, so it is also exponential with rate $\mu + \mu = 2\mu$.
\[
Q = \bordermatrix{% 
	 & 0 & 1 & 2 & 3 & \dots \cr
	0& -\lambda & \lambda  & 0        & 0        & \dots  \cr
	1 & \mu       & -(\lambda+\mu) & \lambda  & 0        & \dots  \cr
	2& 0        & 2\mu        & -(\lambda+2\mu) & \lambda  & \dots  \cr
	3 &0        & 0        & 2\mu        & (-\lambda + 2\mu) & \dots  \cr
	\vdots & \vdots   & \vdots   & \vdots   & \vdots   & \ddots
},
\]
The only rows that are different from the rest are the first and second ones.
In the case of the first one, this is because we can only go from state $X_t = 0$ to $X_{t+1} = 1$ if a customer arrives to the queue, and there is no customer to be serviced so that he can leave the queue.

In the case of the second row, now there is only one customer in the system and so he can only be serviced by a single cashier. This means that the chain will jump to state $0$ with rate $\mu$ if the cashier finishes servicing the customer or to state $2$ with rate $\lambda$ if another customer arrives.

From rows $3$ onwards, there is now at least two customers in the system, and as there are two cashiers the rate at which any one customer exits the system is the minimum between the time it takes the two cashiers to service their customer, which is exponentially distributed with rate $2\mu$ as we have explained previously.
Of course, customers can keep arriving at rate $\lambda$ as there is no limit to the amount of customers in the system.

\subsection*{Question b}
We know from the result in slide 21 of the continuous time Markov chain topic that the stationary distributions satisfies that $\bm{\pi}Q = 0$.
To find the stationary distribution we have to look for $\pi$ such that $\pi_i q_{ij} = \pi_j q_{ji}$.

A general expression for the elements $\pi_k, \ k\geq 1$ in terms of $\pi_0$ is the following:
\[
	\pi_k = \pi_0\left(\frac{\lambda}{\mu}\right)^k \frac{1}{2^{k-1}}
\]

We can obtain an expression for $\pi_0$ from Dobrow 7.6, as this is just a M/M/c queue where we have that
\[
	\pi_0^{-1} = \sum_{k=0}^{c-1} \left(\frac{\lambda}{\mu}\right)^k \frac{1}{k!} + \frac{\lambda / \mu}{c!} \left(\frac{1}{1 - \lambda/c\mu}\right)
\]
So four our case where $c=2$, the sum reduces to:
\[
	\pi_0 = \left(1 + \frac{\lambda}{\mu} + \frac{(\lambda/\mu)^2}{2}\left(\frac{1}{1 - \lambda/2\mu}\right)\right)^{-1}
\]

The long term expected number of people in the system can be obtained from Little's formula, which states that 
\[
	L = \lambda W
\]
Where $L$ is the long term average number of costumers in the system, $W$ is the long term average time of each customer in the system and $\lambda$ is the arrival rate (Dobrow 7.6).

Then, we can obtain the value for $L$ by calculating the expectation of the stationary distribution, as is stated in Dobrow 7.6
\[
	 L = \sum_{k \geq 0} k\pi_k
\]
\subsection*{Question c}
We can see that the only way an overtake can take place is if, once customer $j$ arrives to the queue, there is a customer $i$ being served and a free cashier. 
If there are two free cashiers, customer $j$ has nobody to overtake and if both cashiers are occupied he has to wait until one of them is free (and it does not matter which).

Then, in the case previously described we have that the service time for both customer $j$ and customer $i$ is exponentially distributed. As the exponential distribution is \emph{memoryless}, it does not matter how long customer $i$ has been waiting, as the probability of him being serviced before a given amount of time is the same.

Using the expression introduced in section 2 of \cite{baumann2018number}, we can find the expected number of overtakes as
\[
	\frac{\lambda}{\lambda + 2\mu}
\]
\subsection*{Question d}
The following code has been used to simulate the process for a given number of customers $k$.

\begin{listing}[H]
	\inputminted[firstline = 143, lastline = 166]{R}{../main.R}
	\caption{M/M/2 simulation}
	\label{lst:mm2sim}
\end{listing}
The generated exit times for a particular run of the simulation for 20 clients is:  1.4055, 16.1761, 35.5182, 16.8476, 24.2676, 19.0045, 21.4588, 25.0099, 23.4262, 25.6694, 35.5983, 38.0062, 42.7047,
39.5616, 48.4383, 40.1864, 41.2149, 48.9295, 41.5665, 46.4211 (in the relevant time unit).

\subsection*{Question e}
If two customers arrive every five minutes, this implies a rate $\lambda = \frac{2}{5}$ customers per minute. We also have that $\mathbf{E}\left[ \text{Cashier Serving Time}\right] = 4$. Since it is exponentially distributed, it rate has to be then $\mu = \frac{1}{4}$ customers per minute.


\textbf{Probability of overtaking:} We can get an estimate for this probability by calculating a trajectory of the chain, computing the number of overtakes and dividing by the total length of the chain. This has been done in \cref{lst:overtaking-sim}, where we have performed this procedure a large number of times then taken the average in order to obtain a better estimate.
\begin{listing}[H]
	\inputminted[firstline = 175, lastline = 187]{R}{../main.R}
	\caption{Overtaking Simulation}
	\label{lst:overtaking-sim}
\end{listing}
The resulting estimate for the probability of overtaking is $0.4717$.
\todo[inline]{Add comparison to section c}

\textbf{Long Run Average of people in the system}
In this case what we have done is calculate trajectories for the chain for an increasing number of customers. For each of this trajectories we have calculated the mean of the number of customers in the queue, and our final result is the average of the averages, to get a better estimate. The code can be seen in \cref{lst:longrun-sim}.
\begin{listing}[H]
	\inputminted[firstline = 198, lastline = 203]{R}{../main.R}
	\caption{Long Run Average Simulation}
	\label{lst:longrun-sim}
\end{listing}
The estimated average is then $2.2769$, and we can see a plot of the average number of customers in the system in \cref{fig:lravg}.
\begin{figure}[H]
	\centering
	\input{figures/longrunavg.tex}
	\caption{Long run averages}
	\label{fig:lravg}
\end{figure}

The result that we get if we use the calculation expressed in question b has been approximated numerically by R, truncating the sum seen in the solution of question b to 10 terms. The result is then
\[
	L = \sum_{k = 0}^{100} k \pi_k = 10.1330
\]
The result differs quite a bit from the one obtained by the simulation. We have tried to find out the reason for it, but have ultimately been unsuccessful. 
However we think it is likely a failure of either the simulation procedure or the way that we have calculated the average number of customers in the system.
\end{document}